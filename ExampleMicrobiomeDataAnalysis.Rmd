---
title: "Microbiome data analysis"
author: "Wendy Phillips"
date: "1/23/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Microbiome analysis

First load the libraries that will be used.
```{r, message=FALSE}
library(tidyverse)
library(vegan)
library(ape)
library(cowplot)
library(rstatix)
library(ggpubr)
```

 
These data are from a study of colorectal cancer (CRC), Zackular et al. 2013 (https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3892781/).

Load data: a taxatable and a metadata table. 
```{r}
taxatable <- read.delim("data/zackular_taxatable.csv", sep = ",", check.names = FALSE, row.names = 1)

metadata <- read.delim("data/zackular_metadata.csv", sep = ",", check.names = FALSE, row.names = 1)
```


Check the column sums of the taxa table to see if it has already been normalized.
```{r}
colSums(taxatable)[1:5]
```

Rarefy the count table.  
First check that the sample with the fewest reads still has a reasonable amount of reads.
```{r}
min_reads <- min(colSums(taxatable))
min_reads
```

For amplicon data, 15704 reads is definitely plenty for a minimum to rarefy to.
```{r}
# Transpose the dataframe for use with vegan
taxa_rarefied_t <- data.frame(vegan::rrarefy(t(taxatable), min(colSums(taxatable))))
```

Look at the row sums again to check the table was rarefied appropriately.
```{r}
rowSums(taxa_rarefied_t)[1:5]
```

Remove any taxa that now have a count of zero in all samples.
```{r}
taxa_rarefied_t <- taxa_rarefied_t[, colSums(taxa_rarefied_t) != 0]
```

Now we can calculate some alpha metrics.  
The most basic alpha diversity measure is how many different taxa are observed in each sample.
```{r}
num_taxa <- vegan::specnumber(taxa_rarefied_t)
```

Next, calculate the Shannon-Wiener diversity index.
```{r}
shannon <- vegan::diversity(taxa_rarefied_t, index = "shannon", MARGIN = 1)
```

Also, the inverse Simpson's index.
```{r}
simpson <- vegan::diversity(taxa_rarefied_t, index = "invsimpson", MARGIN = 1)
```

And Chao1.
```{r}
chao1 <- vegan::estimateR(taxa_rarefied_t)[2, ]
```

Now combine all those calculated indices into a single dataframe.
```{r}
alpha_values <- data.frame(Num_taxa = num_taxa, Chao1 = chao1, Shannon = shannon, Simpson = simpson)
```

Add the metadata category of interest to the alpha_values dataframe.
```{r}
alpha_values <- merge(metadata, alpha_values, by = 0)
```

Rename the merged column of `Row.names` to b `Sample`.
```{r}
alpha_values <- alpha_values %>% dplyr::rename("Sample" = "Row.names")
```

Now plots can be made to visualize the results.
```{r}
shannon_plot <- ggplot(alpha_values, aes(x = DiseaseState, y = Shannon)) +
  geom_boxplot(outlier.color = NA, lwd = 0.5) +
  theme_cowplot() +
  geom_jitter(size = 3, width = 0.2, alpha = 0.4, aes(color = DiseaseState)) +
  scale_color_manual(values = c("#7153db", "#008eb0", "magenta")) +
  theme(legend.position = "none") +
  labs(x = "Group")

shannon_plot
```

We could make the above plotting code into function.
```{r}
alpha_plot <- function(input_table, metric) {
  ggplot(input_table, aes_string(x = "DiseaseState", y = metric)) +
    geom_boxplot(outlier.color = NA, lwd = 0.5) +
    theme_cowplot() +
    geom_jitter(size = 3, width = 0.2, alpha = 0.4, aes(color = DiseaseState)) +
    scale_color_manual(values = c("#7153db", "#008eb0", "magenta")) +
    theme(legend.position = "none") +
    labs(x = "Group")
}
```

Try the function with one of the alpha metrics.
```{r}
alpha_plot(alpha_values, "Chao1")
```

The function returns a ggplot object, so you can add extra ggplot arguments to it!
```{r}
alpha_plot(alpha_values, "Num_taxa") + labs(y = "Number of taxa")
```

Now, do a statistical test of whether there is a difference in alpha diversity between the two groups healthy and CRC.
```{r}
wilcox.test(alpha_values$Shannon[alpha_values$DiseaseState == "H"], alpha_values$Shannon[alpha_values$DiseaseState == "CRC"])
```

Add statistical test and its output to the plotting function.
```{r}
alpha_plot_stat <- function(input_table, metric) {
  # Do Wilcoxon rank sum test
  temp <- as.formula(paste0(metric, " ~ DiseaseState"))
  wilc <- input_table %>% rstatix::wilcox_test(temp)

  # Plot with p-value
  ggplot(input_table, aes_string(x = "DiseaseState", y = metric)) +
    geom_boxplot(outlier.color = NA, lwd = 0.5) +
    theme_cowplot() +
    geom_jitter(size = 3, width = 0.2, alpha = 0.4, aes(color = DiseaseState)) +
    scale_color_manual(values = c("#7153db", "#008eb0")) +
    theme(legend.position = "none") +
    labs(x = "Group") +
    ggpubr::stat_pvalue_manual(wilc,
      label = "p",
      y.position = 1.1 * max(alpha_values[, metric])
    )
}
```

Try function with one of the alpha metrics.
```{r}
# Need to subset to just two DiseaseStates
alpha_values_sub <- alpha_values %>% dplyr::filter(DiseaseState %in% c("H", "CRC"))
alpha_plot_stat(alpha_values_sub, "Chao1")
```
